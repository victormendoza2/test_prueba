<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Plantaciones Forestales BPS - GeorreferenciaciÃ³n GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    html, body { height:100%; margin:0; font-family: Arial, sans-serif; }
    body { display:flex; flex-direction:column; background:#f7f7f7; }
    header { background: linear-gradient(90deg,#0b6b2b,#008000); color:white; padding:10px 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    header h1 { margin:0; font-size:16px; }
    header p { margin:4px 0 0 0; font-size:12px; opacity:0.95; }

    .toolbar { display:flex; gap:6px; padding:8px; background:#fff; align-items:center; border-bottom:1px solid #e6e6e6; flex-wrap:wrap; }
    .toolbar button, .toolbar select {
      background:white; border:1px solid #d0d0d0; padding:8px 10px; border-radius:8px;
      cursor:pointer; display:flex; gap:6px; align-items:center; font-size:13px;
    }
    .toolbar button.primary { background:#0b6b2b; color:white; border-color:#0b6b2b; }
    .toolbar .right { margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .infoBox { background:#fff; padding:6px 8px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.08); font-size:13px; text-align:center; }
    #map { flex:1; height: calc(100vh - 120px); }
    .legend { display:flex; gap:8px; align-items:center; font-size:12px; }
    .dot { width:12px; height:12px; border-radius:50%; display:inline-block; border:1px solid rgba(0,0,0,0.1); }
    .label { background: rgba(255,255,255,0.95); padding:4px 6px; border-radius:6px; border:1px solid #ddd; font-size:12px; font-weight:600; }

    #status-msg {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      background: rgba(11,107,43,0.95); color: white; padding: 8px 16px;
      border-radius: 20px; font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      opacity: 0; transition: opacity 0.35s ease-in-out; z-index: 9999;
    }
    #status-msg.show { opacity: 1; }
  </style>
</head>

<body>

  <header>
    <h1>ðŸŒ³ Plantaciones Forestales BPS â€” Victor Enrique Mendoza Astopilco</h1>
    <p>Especialista en GestiÃ³n del Catastro Forestal - BPS</p>
  </header>

  <div id="status-msg"></div>

  <div class="toolbar">
    <button id="btn-gps"><i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS</button>
    <button id="btn-gps-vertex" class="primary"><i class="fa-solid fa-crosshairs"></i>&nbsp;Agregar vÃ©rtice GPS</button>

    <label>
      <input id="file-input" type="file" accept=".csv,.xlsx" style="display:none"/>
      <button id="btn-upload"><i class="fa-solid fa-file-import"></i>&nbsp;Cargar CSV / Excel</button>
    </label>

    <select id="crs-select">
      <option value="4326">EPSG:4326 (Lat/Lon)</option>
      <option value="32717">EPSG:32717 (UTM 17S)</option>
      <option value="32718" selected>EPSG:32718 (UTM 18S)</option>
      <option value="32719">EPSG:32719 (UTM 19S)</option>
    </select>

    <button id="btn-clear"><i class="fa-solid fa-trash"></i>&nbsp;Limpiar</button>

    <div class="right">
      <div class="infoBox" id="info-precision">ðŸ“¡ PrecisiÃ³n: -- m</div>
      <div class="legend">
        <div><span class="dot" style="background:#2ecc71"></span><small>&lt;5m</small></div>
        <div><span class="dot" style="background:#f1c40f"></span><small>5-7m</small></div>
        <div><span class="dot" style="background:#e74c3c"></span><small>&gt;7m</small></div>
      </div>
      <button id="btn-download-geo"><i class="fa-solid fa-download"></i></button>
      <button id="btn-download-csv"><i class="fa-solid fa-file-csv"></i></button>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

  <script>
  /* ---------- FUNCIONES DE UI ---------- */
  function showStatus(msg, color="#0b6b2b") {
    const el = document.getElementById('status-msg');
    el.style.background = color;
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(() => el.classList.remove('show'), 1800);
  }

  /* ---------- DEFINICIÃ“N DE PROYECCIONES ---------- */
  proj4.defs("EPSG:32717","+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs");
  proj4.defs("EPSG:32718","+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs");
  proj4.defs("EPSG:32719","+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs");

  /* ---------- MAPA ---------- */
  const map = L.map('map').setView([-7.2, -78.5], 8);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}');
  L.control.layers({"OSM":osm,"Google SatÃ©lite":googleSat}).addTo(map);

  const gpsLayer = new L.FeatureGroup().addTo(map);
  const uploadedLayer = new L.FeatureGroup().addTo(map);
  const drawnItems = new L.FeatureGroup().addTo(map);
  const trackLayer = L.polyline([], { color:'red', weight:3 }).addTo(map);

  let gpsMarker=null, accuracyCircle=null, watchId=null;
  let gpsVertices=[], trackCoords=[];
  let activePolygon=null, lastTrackPoint=null;

  const infoPrecision=document.getElementById('info-precision');

  /* ---------- ETIQUETAS DE ÃREA ---------- */
  function addOrUpdateLabel(layer){
    try {
      const a = turf.area(layer.toGeoJSON());
      const c = layer.getBounds().getCenter();
      if(layer._label) map.removeLayer(layer._label);
      layer._label = L.marker(c,{icon:L.divIcon({className:'label',html:`${(a/10000).toFixed(2)} ha`})}).addTo(map);
    } catch(e) {}
  }

  function clearAllLabels(){
    map.eachLayer(l => { 
      if(l instanceof L.Marker && l.options.icon?.options?.className === 'label') 
        map.removeLayer(l); 
    });
    drawnItems.eachLayer(l => { if(l._label){ map.removeLayer(l._label); delete l._label; }});
  }

  /* ---------- DIBUJO MANUAL ---------- */
  const drawControl = new L.Control.Draw({
    draw:{ polygon:{allowIntersection:false,showArea:true,shapeOptions:{color:'#0b6b2b'}}, marker:true, polyline:false, rectangle:false, circle:false, circlemarker:false },
    edit:{ featureGroup:drawnItems }
  });
  map.addControl(drawControl);

  map.on(L.Draw.Event.CREATED,e=>{
    drawnItems.addLayer(e.layer);
    if(e.layer instanceof L.Polygon) addOrUpdateLabel(e.layer);
    saveSession();
  });

  map.on(L.Draw.Event.EDITED,e=>{
    e.layers.eachLayer(l=>{ 
      if(l instanceof L.Polygon) addOrUpdateLabel(l);
    });
    saveSession();
  });

  map.on(L.Draw.Event.DELETED,()=>{
    clearAllLabels();
    saveSession();
  });

  /* ---------- GPS DINÃMICO ---------- */
  document.getElementById('btn-gps').onclick=()=>{

    if(watchId){
      navigator.geolocation.clearWatch(watchId);
      watchId=null;
      document.getElementById('btn-gps').innerHTML='<i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS';
      showStatus('GPS detenido','#d9534f');
      return;
    }

    if(!navigator.geolocation) return alert('GPS no disponible.');

    document.getElementById('btn-gps').innerHTML='<i class="fa-solid fa-stop"></i>&nbsp;Detener GPS';
    showStatus('GPS activado');

    watchId=navigator.geolocation.watchPosition(p=>{
      const lat=p.coords.latitude, lng=p.coords.longitude, acc=p.coords.accuracy;

      if(!gpsMarker)
        gpsMarker=L.circleMarker([lat,lng],{radius:8,color:'#ff5722',fillColor:'#ff5722',fillOpacity:1}).addTo(map);

      gpsMarker.setLatLng([lat,lng]);
      gpsMarker.accuracy=acc;

      if(accuracyCircle) map.removeLayer(accuracyCircle);
      accuracyCircle=L.circle([lat,lng],{radius:acc,color:'#0b6b2b',fillOpacity:0.08}).addTo(map);

      infoPrecision.innerText=`ðŸ“¡ PrecisiÃ³n: ${acc.toFixed(1)} m`;
      saveSession();

    },err=>alert("Error GPS: "+err.message),{enableHighAccuracy:true});
  };

  /* ---------- AGREGAR VÃ‰RTICE GPS ---------- */
  document.getElementById('btn-gps-vertex').onclick=()=>{
    if(!gpsMarker) return alert('Activa el GPS primero.');

    const p=gpsMarker.getLatLng();
    gpsVertices.push([p.lat,p.lng]);

    L.circleMarker(p,{radius:5,color:'#0b6b2b',fillColor:'#0b6b2b',fillOpacity:1}).addTo(gpsLayer);

    if(!activePolygon && gpsVertices.length>=3){
      activePolygon=L.polygon(gpsVertices,{color:'#0b6b2b',fillOpacity:0.12}).addTo(gpsLayer);
      addOrUpdateLabel(activePolygon);
    }
    else if(activePolygon){
      activePolygon.setLatLngs(gpsVertices);
      addOrUpdateLabel(activePolygon);
    }

    saveSession();
  };

  /* ---------- CARGA DE ARCHIVOS ---------- */
  document.getElementById('btn-upload').onclick=()=>document.getElementById('file-input').click();

  document.getElementById('file-input').onchange=e=>{
    const file=e.target.files[0];
    if(!file) return;

    const ext=file.name.split('.').pop().toLowerCase();
    const crs=document.getElementById('crs-select').value;

    if(ext==='csv') parseCSV(file,crs);
    else parseXLSX(file,crs);
  };

  function parseCSV(file,crs){
    Papa.parse(file,{header:true,complete:r=>handleRows(r.data,crs)});
  }

  function parseXLSX(file,crs){
    const reader=new FileReader();
    reader.onload=e=>{
      const wb=XLSX.read(e.target.result,{type:'binary'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const data=XLSX.utils.sheet_to_json(ws,{header:1});

      const headers=data[0].map(h=>String(h).toLowerCase());
      const colE=headers.findIndex(h=>h.includes('este')||h==='x'||h==='e');
      const colN=headers.findIndex(h=>h.includes('norte')||h==='y'||h==='n');

      const coords=data.slice(1).map(r=>[parseFloat(r[colE]),parseFloat(r[colN])]);

      handleRows(coords,crs,true);
    };
    reader.readAsBinaryString(file);
  }

  /* ------------------------------------------------------
     NUEVA FUNCIÃ“N COMPLETA: GENERA EL POLÃGONO + ÃREA
     ------------------------------------------------------ */
  function handleRows(rows, crs, isArray=false) {
    uploadedLayer.clearLayers();

    let cargados = [];   // almacena todos los puntos transformados

    rows.forEach(r => {
      let x, y;

      if (isArray) {
        x = r[0];
        y = r[1];
      } else {
        x = parseFloat(r.Este || r.X || r.lon || r.Longitud);
        y = parseFloat(r.Norte || r.Y || r.lat || r.Latitud);
      }

      if (isNaN(x) || isNaN(y)) return;

      let latlng;

      if (crs === '4326') {
        latlng = [y, x];
      } else {
        try {
          const t = proj4('EPSG:' + crs, 'EPSG:4326', [x, y]);
          latlng = [t[1], t[0]];
        } catch {
          latlng = [y, x];
        }
      }

      cargados.push(latlng);

      L.circleMarker(latlng, {
        radius: 5,
        color: '#007bff',
        fillColor: '#007bff',
        fillOpacity: 0.9
      }).addTo(uploadedLayer);
    });

    /* ------ SI EXISTEN â‰¥ 3 PUNTOS, FORMAR POLÃGONO ------ */
    if (cargados.length >= 3) {
      const poly = L.polygon(cargados, {
        color: "#0056b3",
        fillOpacity: 0.15
      }).addTo(uploadedLayer);

      addOrUpdateLabel(poly);
    }

    if (uploadedLayer.getLayers().length > 0) {
      map.fitBounds(uploadedLayer.getBounds().pad(0.1));
    }

    showStatus("âœ… Coordenadas cargadas y Ã¡rea generada correctamente");

    saveSession();
  }

  /* ---------- GUARDAR SESIÃ“N ---------- */
  function saveSession(){
    const data={
      drawn:drawnItems.toGeoJSON(),
      gps:gpsLayer.toGeoJSON(),
      uploaded:uploadedLayer.toGeoJSON(),
      track:trackCoords
    };
    localStorage.setItem("bps_sesion",JSON.stringify(data));
  }

  /* ---------- LIMPIAR ---------- */
  document.getElementById('btn-clear').onclick=()=>{
    if(!confirm('Â¿Eliminar todo?')) return;

    gpsLayer.clearLayers();
    drawnItems.clearLayers();
    uploadedLayer.clearLayers();
    trackLayer.setLatLngs([]);

    gpsVertices=[]; trackCoords=[]; activePolygon=null; lastTrackPoint=null;

    if(gpsMarker){ map.removeLayer(gpsMarker); gpsMarker=null; }
    if(accuracyCircle){ map.removeLayer(accuracyCircle); accuracyCircle=null; }

    clearAllLabels();
    infoPrecision.innerText='ðŸ“¡ PrecisiÃ³n: -- m';
    localStorage.removeItem("bps_sesion");

    if(watchId){
      navigator.geolocation.clearWatch(watchId);
      watchId=null;
      document.getElementById('btn-gps').innerHTML='<i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS';
    }

    showStatus('ðŸ§¹ Todo eliminado','#d9534f');
  };

  </script>

</body>
</html>


