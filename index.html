<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Plantaciones Forestales BPS - GeorreferenciaciÃ³n GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    html, body { height:100%; margin:0; font-family: Arial, sans-serif; }
    body { display:flex; flex-direction:column; background:#f7f7f7; }
    header { background: linear-gradient(90deg,#0b6b2b,#008000); color:white; padding:10px 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    header h1 { margin:0; font-size:16px; }
    header p { margin:4px 0 0 0; font-size:12px; opacity:0.95; }

    .toolbar { display:flex; gap:6px; padding:8px; background:#fff; align-items:center; border-bottom:1px solid #e6e6e6; flex-wrap:wrap; }
    .toolbar button, .toolbar select {
      background:white; border:1px solid #d0d0d0; padding:8px 10px; border-radius:8px;
      cursor:pointer; display:flex; gap:6px; align-items:center; font-size:13px;
    }
    .toolbar button.primary { background:#0b6b2b; color:white; border-color:#0b6b2b; }
    .toolbar .right { margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    #map { flex:1; height: calc(100vh - 120px); }

    .label {
      background: rgba(255,255,255,0.95);
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #ddd;
      font-size:12px;
      font-weight:600;
    }

    #status-msg {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      background: rgba(11,107,43,0.95); color: white; padding: 8px 16px;
      border-radius: 20px; font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      opacity: 0; transition: opacity 0.35s ease-in-out; z-index: 9999;
    }
    #status-msg.show { opacity: 1; }
  </style>

</head>
<body>

<header>
  <h1>ðŸŒ³ Plantaciones Forestales BPS â€” Victor Enrique Mendoza Astopilco</h1>
  <p>Especialista en GestiÃ³n del Catastro Forestal - BPS</p>
</header>

<div id="status-msg"></div>

<div class="toolbar">
  <button id="btn-gps"><i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS</button>
  <button id="btn-gps-vertex" class="primary"><i class="fa-solid fa-crosshairs"></i>&nbsp;Agregar vÃ©rtice GPS</button>

  <label>
    <input id="file-input" type="file" accept=".csv,.xlsx" style="display:none"/>
    <button id="btn-upload"><i class="fa-solid fa-file-import"></i>&nbsp;Cargar CSV / Excel</button>
  </label>

  <select id="crs-select">
    <option value="4326">EPSG:4326 (Lat/Lon)</option>
    <option value="32717">EPSG:32717 (UTM 17S)</option>
    <option value="32718" selected>EPSG:32718 (UTM 18S)</option>
    <option value="32719">EPSG:32719 (UTM 19S)</option>
  </select>

  <button id="btn-clear"><i class="fa-solid fa-trash"></i>&nbsp;Limpiar</button>

  <div class="right">
    <button id="btn-download-geo"><i class="fa-solid fa-download"></i></button>
    <button id="btn-download-csv"><i class="fa-solid fa-file-csv"></i></button>
  </div>
</div>

<div id="map"></div>

<!-- LibrerÃ­as -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

<script>

// -----------------------------------------------------
//   Mensajes
// -----------------------------------------------------
function showStatus(msg, color = "#0b6b2b") {
  const el = document.getElementById("status-msg");
  el.style.background = color;
  el.textContent = msg;
  el.classList.add("show");
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove("show"), 1800);
}

// -----------------------------------------------------
//   DefiniciÃ³n de CRS UTM
// -----------------------------------------------------
proj4.defs("EPSG:32717","+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs");
proj4.defs("EPSG:32718","+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs");
proj4.defs("EPSG:32719","+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs");

// -----------------------------------------------------
//   Mapa
// -----------------------------------------------------
const map = L.map("map").setView([-7.2, -78.5], 8);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// Capas
const uploadedLayer = L.featureGroup().addTo(map);

// -----------------------------------------------------
//   Etiquetas (Ã¡rea)
// -----------------------------------------------------
function addOrUpdateLabel(layer) {
  const gj = layer.toGeoJSON();
  const area = turf.area(gj) / 10000; // ha
  const center = layer.getBounds().getCenter();

  if (layer._label) map.removeLayer(layer._label);

  layer._label = L.marker(center, {
    icon: L.divIcon({
      className: "label",
      html: `${area.toFixed(2)} ha`
    })
  }).addTo(map);
}

// -----------------------------------------------------
//   Cargar archivos CSV / Excel
// -----------------------------------------------------
document.getElementById("btn-upload").onclick = () =>
  document.getElementById("file-input").click();

document.getElementById("file-input").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const ext = file.name.split(".").pop().toLowerCase();
  const crs = document.getElementById("crs-select").value;

  if (ext === "csv") parseCSV(file, crs);
  else parseXLSX(file, crs);
};

// CSV
function parseCSV(file, crs) {
  Papa.parse(file, {
    header: true,
    complete: r => handleRows(r.data, crs)
  });
}

// Excel
function parseXLSX(file, crs) {
  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "binary" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });

    const headers = data[0].map(h => String(h).toLowerCase());
    const colE = headers.findIndex(h => h.includes("e") || h.includes("este") || h === "x");
    const colN = headers.findIndex(h => h.includes("n") || h.includes("norte") || h === "y");

    const coords = data.slice(1).map(r => [parseFloat(r[colE]), parseFloat(r[colN])]);
    handleRows(coords, crs, true);
  };
  reader.readAsBinaryString(file);
}

// -----------------------------------------------------
//   PROCESAMIENTO Y CREACIÃ“N DEL POLÃGONO
// -----------------------------------------------------
function handleRows(rows, crs, isArray = false) {
  uploadedLayer.clearLayers();

  let coords = [];

  rows.forEach(r => {
    let x, y;

    if (isArray) {
      x = r[0];
      y = r[1];
    } else {
      x = parseFloat(r.Este || r.X || r.Longitud || r.lon);
      y = parseFloat(r.Norte || r.Y || r.Latitud || r.lat);
    }

    if (isNaN(x) || isNaN(y)) return;

    let latlng;

    if (crs === "4326") {
      latlng = [y, x];
    } else {
      const t = proj4("EPSG:" + crs, "EPSG:4326", [x, y]);
      latlng = [t[1], t[0]];
    }

    coords.push(latlng);

    L.circleMarker(latlng, {
      radius: 5,
      color: "#007bff",
      fillColor: "#007bff",
      fillOpacity: 1
    }).addTo(uploadedLayer);
  });

  // Crear polÃ­gono automÃ¡tico
  if (coords.length >= 3) {
    const first = coords[0];
    const last = coords[coords.length - 1];

    if (first[0] !== last[0] || first[1] !== last[1]) coords.push(first);

    const polygon = L.polygon(coords, {
      color: "#0056b3",
      fillOpacity: 0.25
    }).addTo(uploadedLayer);

    addOrUpdateLabel(polygon);

    // NECESARIO PARA LA DESCARGA
    saveGeometry(polygon);
  }

  if (uploadedLayer.getLayers().length > 0)
    map.fitBounds(uploadedLayer.getBounds().pad(0.15));

  showStatus("ðŸ“Œ Coordenadas cargadas, polÃ­gono creado y Ã¡rea calculada");
}

// -----------------------------------------------------
//   ALMACENAR GEOMETRÃA PARA DESCARGA
// -----------------------------------------------------
let geometries = [];

function saveGeometry(layer) {
  geometries.push(layer.toGeoJSON());
}

// -----------------------------------------------------
//   DESCARGAR GEOJSON
// -----------------------------------------------------
document.getElementById("btn-download-geo").onclick = () => {
  const fc = {
    type: "FeatureCollection",
    features: geometries
  };

  const blob = new Blob([JSON.stringify(fc)], { type: "application/geo+json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "poligonos.geojson";
  a.click();

  URL.revokeObjectURL(url);
};

// -----------------------------------------------------
//   DESCARGAR CSV
// -----------------------------------------------------
document.getElementById("btn-download-csv").onclick = () => {
  let csv = "lat,lon\n";

  geometries.forEach(f => {
    if (f.geometry.type === "Polygon") {
      f.geometry.coordinates[0].forEach(c => {
        csv += `${c[1]},${c[0]}\n`;
      });
    }
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "poligono.csv";
  a.click();

  URL.revokeObjectURL(url);
};

// -----------------------------------------------------
//   LIMPIAR TODO
// -----------------------------------------------------
document.getElementById("btn-clear").onclick = () => {
  if (!confirm("Â¿Deseas eliminar todo?")) return;

  geometries = [];
  uploadedLayer.clearLayers();

  showStatus("ðŸ§¹ Todo eliminado", "#d9534f");
};

</script>

</body>
</html>





