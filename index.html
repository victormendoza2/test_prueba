<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Plantaciones Forestales BPS - GeorreferenciaciÃ³n GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    html, body { height:100%; margin:0; font-family: Arial, sans-serif; }
    body { display:flex; flex-direction:column; background:#f7f7f7; }
    header { background: linear-gradient(90deg,#0b6b2b,#008000); color:white; padding:10px 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); }
    header h1 { margin:0; font-size:16px; }
    header p { margin:4px 0 0 0; font-size:12px; opacity:0.95; }

    .toolbar { display:flex; gap:6px; padding:8px; background:#fff; align-items:center; border-bottom:1px solid #e6e6e6; flex-wrap:wrap; }
    .toolbar button, .toolbar select {
      background:white; border:1px solid #d0d0d0; padding:8px 10px; border-radius:8px;
      cursor:pointer; display:flex; gap:6px; align-items:center; font-size:13px;
    }
    .toolbar button.primary { background:#0b6b2b; color:white; border-color:#0b6b2b; }
    .toolbar .right { margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .infoBox { background:#fff; padding:6px 8px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.08); font-size:13px; text-align:center; }
    #map { flex:1; height: calc(100vh - 120px); }
    .legend { display:flex; gap:8px; align-items:center; font-size:12px; }
    .dot { width:12px; height:12px; border-radius:50%; display:inline-block; border:1px solid rgba(0,0,0,0.1); }
    .label { background: rgba(255,255,255,0.95); padding:4px 6px; border-radius:6px; border:1px solid #ddd; font-size:12px; font-weight:600; }

    #status-msg {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
      background: rgba(11,107,43,0.95); color: white; padding: 8px 16px;
      border-radius: 20px; font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      opacity: 0; transition: opacity 0.35s ease-in-out; z-index: 9999;
    }
    #status-msg.show { opacity: 1; }
  </style>
</head>
<body>

  <header>
    <h1>ðŸŒ³ Plantaciones Forestales BPS â€” Victor Enrique Mendoza Astopilco</h1>
    <p>Especialista en GestiÃ³n del Catastro Forestal - BPS</p>
  </header>

  <div id="status-msg" role="status" aria-live="polite"></div>

  <div class="toolbar">
    <button id="btn-gps"><i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS</button>
    <button id="btn-gps-vertex" class="primary"><i class="fa-solid fa-crosshairs"></i>&nbsp;Agregar vÃ©rtice GPS</button>

    <label>
      <input id="file-input" type="file" accept=".csv,.xlsx" style="display:none"/>
      <button id="btn-upload"><i class="fa-solid fa-file-import"></i>&nbsp;Cargar CSV / Excel</button>
    </label>

    <select id="crs-select">
      <option value="4326">EPSG:4326 (Lat/Lon)</option>
      <option value="32717">EPSG:32717 (UTM 17S)</option>
      <option value="32718" selected>EPSG:32718 (UTM 18S)</option>
      <option value="32719">EPSG:32719 (UTM 19S)</option>
    </select>

    <button id="btn-clear"><i class="fa-solid fa-trash"></i>&nbsp;Limpiar</button>

    <div class="right">
      <div class="infoBox" id="info-precision">ðŸ“¡ PrecisiÃ³n: -- m</div>
      <div class="legend">
        <div><span class="dot" style="background:#2ecc71"></span><small>&lt;5m</small></div>
        <div><span class="dot" style="background:#f1c40f"></span><small>5-7m</small></div>
        <div><span class="dot" style="background:#e74c3c"></span><small>&gt;7m</small></div>
      </div>
      <button id="btn-download-geo" title="Descargar GeoJSON"><i class="fa-solid fa-download"></i></button>
      <button id="btn-download-csv" title="Descargar CSV"><i class="fa-solid fa-file-csv"></i></button>
    </div>
  </div>

  <div id="map"></div>

  <!-- LibrerÃ­as -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

  <script>
  // ---------- Mensajes ----------
  function showStatus(msg, color="#0b6b2b") {
    const el = document.getElementById('status-msg');
    el.style.background = color;
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(()=> el.classList.remove('show'), 1800);
  }

  // ---------- CRS ----------
  proj4.defs("EPSG:32717","+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs");
  proj4.defs("EPSG:32718","+proj=utm +zone=18 +south +datum=WGS84 +units=m +no_defs");
  proj4.defs("EPSG:32719","+proj=utm +zone=19 +south +datum=WGS84 +units=m +no_defs");

  // ---------- Mapa ----------
  const map = L.map('map').setView([-7.2, -78.5], 8);
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
  const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{attribution:'Â© Google'});
  L.control.layers({"OSM":osm,"Google SatÃ©lite":googleSat}).addTo(map);

  // ---------- Capas ----------
  const gpsLayer = new L.FeatureGroup().addTo(map);
  const uploadedLayer = new L.FeatureGroup().addTo(map);
  const drawnItems = new L.FeatureGroup().addTo(map);
  const trackLayer = L.polyline([], { color:'red', weight:3 }).addTo(map);

  let gpsMarker=null, accuracyCircle=null, watchId=null;
  let gpsVertices=[], trackCoords=[];
  let activePolygon=null, lastTrackPoint=null;
  const precisionGood=5, precisionMed=7;
  const infoPrecision=document.getElementById('info-precision');

  // ---------- Array global de geometrÃ­as para descarga ----------
  let geometries = [];

  // ---------- Etiquetas ----------
  function addOrUpdateLabel(layer){
    try {
      // area en m2 -> pasar a hectÃ¡reas
      const area_m2 = turf.area(layer.toGeoJSON());
      const area_ha = area_m2 / 10000;
      const area_ha_rounded = parseFloat(area_ha.toFixed(3)); // 3 decimales

      const center = layer.getBounds().getCenter();
      if(layer._label) map.removeLayer(layer._label);
      layer._label = L.marker(center,{icon:L.divIcon({className:'label',html:`${area_ha_rounded} ha`})}).addTo(map);

      // Si la geometrÃ­a ya fue guardada en 'geometries', actualizar su propiedad area_ha
      // (si existe featureId lo podrÃ­as usar; aquÃ­ actualizamos buscando igualdad geomÃ©trica simple)
      try {
        const gj = layer.toGeoJSON();
        const coordsStr = JSON.stringify(gj.geometry.coordinates);
        for(let i=0;i<geometries.length;i++){
          if(JSON.stringify(geometries[i].geometry.coordinates) === coordsStr){
            geometries[i].properties = geometries[i].properties || {};
            geometries[i].properties.area_ha = area_ha_rounded;
            break;
          }
        }
      } catch(e){}
    } catch(e){}
  }

  function clearAllLabels(){
    map.eachLayer(l => { if(l instanceof L.Marker && l.options.icon?.options?.className === 'label') map.removeLayer(l); });
    drawnItems.eachLayer(l => { if(l._label){ map.removeLayer(l._label); delete l._label; }});
  }

  // ---------- Dibujo manual ----------
  const drawControl = new L.Control.Draw({
    draw:{ polygon:{allowIntersection:false,showArea:true,shapeOptions:{color:'#0b6b2b'}}, marker:true, polyline:false, rectangle:false, circle:false, circlemarker:false },
    edit:{ featureGroup:drawnItems, edit:true, remove:true }
  });
  map.addControl(drawControl);
  map.on(L.Draw.Event.CREATED,e=>{drawnItems.addLayer(e.layer);if(e.layer instanceof L.Polygon) { addOrUpdateLabel(e.layer); saveGeometry(e.layer); } saveSession();});
  map.on(L.Draw.Event.EDITED,e=>{e.layers.eachLayer(l=>{if(l instanceof L.Polygon)addOrUpdateLabel(l);});saveSession();});
  map.on(L.Draw.Event.DELETED,()=>{clearAllLabels();saveSession();});

  // ---------- GPS dinÃ¡mico ----------
  document.getElementById('btn-gps').onclick=()=>{
    if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;document.getElementById('btn-gps').innerHTML='<i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS';showStatus('GPS detenido','#d9534f');return;}
    if(!navigator.geolocation)return alert('GPS no disponible.');
    document.getElementById('btn-gps').innerHTML='<i class="fa-solid fa-stop"></i>&nbsp;Detener GPS';
    showStatus('GPS activado');

    watchId=navigator.geolocation.watchPosition(p=>{
      const lat=p.coords.latitude,lng=p.coords.longitude,acc=p.coords.accuracy;
      if(!gpsMarker)gpsMarker=L.circleMarker([lat,lng],{radius:8,color:'#ff5722',fillColor:'#ff5722',fillOpacity:1}).addTo(map);
      gpsMarker.setLatLng([lat,lng]);gpsMarker.accuracy=acc;
      if(accuracyCircle)map.removeLayer(accuracyCircle);
      accuracyCircle=L.circle([lat,lng],{radius:acc,color:colorForPrecision(acc),weight:1,fillOpacity:0.08}).addTo(map);

      if(acc<precisionGood)gpsMarker.setStyle({color:'#2ecc71',fillColor:'#2ecc71'});
      else if(acc<=precisionMed)gpsMarker.setStyle({color:'#f1c40f',fillColor:'#f1c40f'});
      else gpsMarker.setStyle({color:'#e74c3c',fillColor:'#e74c3c'});

      const current=[lat,lng];
      if(!lastTrackPoint||distanceMeters(lastTrackPoint,current)>10){
        trackCoords.push(current);
        trackLayer.setLatLngs(trackCoords);
        lastTrackPoint=current;
      }

      infoPrecision.innerText=`ðŸ“¡ PrecisiÃ³n: ${acc.toFixed(1)} m`;
      saveSession();
    },err=>alert("Error GPS: "+err.message),{enableHighAccuracy:true});
  };

  function colorForPrecision(acc){
    if(acc<=5)return'#2ecc71';
    if(acc<=7)return'#f1c40f';
    return'#e74c3c';
  }

  function distanceMeters(a,b){
    const R=6371000,rad=Math.PI/180;
    const dLat=(b[0]-a[0])*rad,dLon=(b[1]-a[1])*rad;
    const lat1=a[0]*rad,lat2=b[0]*rad;
    const hav=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(hav));
  }

  document.getElementById('btn-gps-vertex').onclick=()=>{
    if(!gpsMarker)return alert('Activa el GPS primero.');
    const acc=gpsMarker.accuracy||999;
    if(acc>precisionMed&&!confirm(`PrecisiÃ³n baja (${acc.toFixed(1)} m). Â¿Agregar vÃ©rtice igualmente?`))return;
    const p=gpsMarker.getLatLng();
    gpsVertices.push([p.lat,p.lng]);
    L.circleMarker(p,{radius:5,color:'#0b6b2b',fillColor:'#0b6b2b',fillOpacity:1}).addTo(gpsLayer);
    if(!activePolygon&&gpsVertices.length>=3){
      activePolygon=L.polygon(gpsVertices,{color:'#0b6b2b',fillOpacity:0.12}).addTo(gpsLayer);
      addOrUpdateLabel(activePolygon);
      saveGeometry(activePolygon);
    }else if(activePolygon){
      activePolygon.setLatLngs(gpsVertices);
      addOrUpdateLabel(activePolygon);
    }
    saveSession();
  };

  // ---------- Cargar archivos ----------
  document.getElementById('btn-upload').onclick=()=>document.getElementById('file-input').click();
  document.getElementById('file-input').onchange=e=>{
    const file=e.target.files[0]; if(!file)return;
    const ext=file.name.split('.').pop().toLowerCase();
    const crs=document.getElementById('crs-select').value;
    if(ext==='csv')parseCSV(file,crs);else parseXLSX(file,crs);
  };
  function parseCSV(file,crs){Papa.parse(file,{header:true,complete:r=>handleRows(r.data,crs)});}
  function parseXLSX(file,crs){
    const reader=new FileReader();
    reader.onload=e=>{
      const wb=XLSX.read(e.target.result,{type:'binary'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const data=XLSX.utils.sheet_to_json(ws,{header:1});
      const headers=data[0].map(h=>String(h).toLowerCase());
      const colE=headers.findIndex(h=>h.includes('este')||h==='x'||h==='e');
      const colN=headers.findIndex(h=>h.includes('norte')||h==='y'||h==='n');
      const coords=data.slice(1).map(r=>[parseFloat(r[colE]),parseFloat(r[colN])]);
      handleRows(coords,crs,true);
    };
    reader.readAsBinaryString(file);
  }

  // ---------- Procesamiento y generaciÃ³n de polÃ­gono (coordenadas redondeadas a 3 decimales; Ã¡rea en ha a 3 decimales) ----------
  function handleRows(rows, crs, isArray = false) {
    uploadedLayer.clearLayers();
    let cargados = [];

    rows.forEach(r => {
      let x, y;

      if (isArray) {
        x = parseFloat(r[0]);
        y = parseFloat(r[1]);
      } else {
        x = parseFloat(r.Este || r.X || r.x || r.Longitud || r.Lon || r.lon || r.longitude);
        y = parseFloat(r.Norte || r.Y || r.y || r.Latitud || r.Lat || r.lat || r.latitude);
      }

      if (isNaN(x) || isNaN(y)) return;

      let latlng;
      if (crs === "4326") {
        latlng = [y, x];
      } else {
        try { const t = proj4("EPSG:" + crs, "EPSG:4326", [x, y]); latlng = [t[1], t[0]]; }
        catch { latlng = [y, x]; }
      }

      // redondeo a 3 decimales
      const rounded = [ parseFloat(latlng[0].toFixed(3)), parseFloat(latlng[1].toFixed(3)) ];
      cargados.push(rounded);

      L.circleMarker(rounded, { radius:5, color:'#007bff', fillColor:'#007bff', fillOpacity:0.9 }).addTo(uploadedLayer);
    });

    if (cargados.length >= 3) {
      const first = cargados[0];
      const last = cargados[cargados.length - 1];
      if (first[0] !== last[0] || first[1] !== last[1]) cargados.push(first);

      const poly = L.polygon(cargados, { color:'#0056b3', fillOpacity:0.15 }).addTo(uploadedLayer);

      // calcular Ã¡rea en ha y aÃ±adir etiqueta y registro para descarga
      addOrUpdateLabel(poly);
      saveGeometry(poly);
    }

    if (uploadedLayer.getLayers().length > 0) map.fitBounds(uploadedLayer.getBounds().pad(0.1));
    showStatus('âœ… Coordenadas cargadas, polÃ­gono generado y Ã¡rea calculada (ha, 3 decimales)');
    saveSession();
  }

  // ---------- Guardar geometrÃ­a (GeoJSON) con propiedad area_ha ----------
  function saveGeometry(layer){
    try {
      const gj = layer.toGeoJSON();
      const area_m2 = turf.area(gj);
      const area_ha = parseFloat((area_m2/10000).toFixed(3)); // ha con 3 decimales
      gj.properties = gj.properties || {};
      gj.properties.area_ha = area_ha;
      geometries.push(gj);
    } catch(e){}
  }

  // ---------- Guardar sesiÃ³n ----------
  function saveSession(){
    const data={drawn:drawnItems.toGeoJSON(),gps:gpsLayer.toGeoJSON(),uploaded:uploadedLayer.toGeoJSON(),track:trackCoords};
    localStorage.setItem("bps_sesion",JSON.stringify(data));
  }
  window.addEventListener("load",()=>{
    const saved=localStorage.getItem("bps_sesion");
    if(saved&&confirm("ðŸ”„ Â¿Deseas restaurar tu Ãºltima sesiÃ³n?")){
      const data=JSON.parse(saved);
      L.geoJSON(data.drawn,{onEachFeature:(f,l)=>{drawnItems.addLayer(l);if(l instanceof L.Polygon)addOrUpdateLabel(l);}});;
      L.geoJSON(data.gps,{onEachFeature:(f,l)=>gpsLayer.addLayer(l)});
      L.geoJSON(data.uploaded,{onEachFeature:(f,l)=>uploadedLayer.addLayer(l)});
      trackCoords=data.track||[];trackLayer.setLatLngs(trackCoords);
    }
  });

  // ---------- Descarga GeoJSON (incluye propiedades con area_ha) ----------
  document.getElementById('btn-download-geo').onclick=()=>{
    const fc = { type:'FeatureCollection', features: geometries };
    const blob = new Blob([JSON.stringify(fc)],{type:'application/geo+json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='poligonos.geojson'; a.click(); URL.revokeObjectURL(url);
    showStatus('âœ… GeoJSON descargado');
  };

  // ---------- Descarga CSV: centroid_lat, centroid_lon, area_ha ----------
  document.getElementById('btn-download-csv').onclick=()=>{
    let csv = "centroid_lat,centroid_lon,area_ha\n";
    geometries.forEach(f=>{
      if(f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon')){
        const centroid = turf.centroid(f).geometry.coordinates; // [lon, lat]
        const area_ha = (f.properties && f.properties.area_ha) ? f.properties.area_ha : parseFloat((turf.area(f)/10000).toFixed(3));
        csv += `${centroid[1]},${centroid[0]},${area_ha}\n`;
      }
    });
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='poligonos_centroides.csv'; a.click(); URL.revokeObjectURL(url);
    showStatus('âœ… CSV descargado');
  };

  // ---------- Limpiar ----------
  document.getElementById('btn-clear').onclick=()=>{
    if(!confirm('Â¿Eliminar todo?'))return;
    gpsLayer.clearLayers();drawnItems.clearLayers();uploadedLayer.clearLayers();trackLayer.setLatLngs([]);
    gpsVertices=[];trackCoords=[];activePolygon=null;lastTrackPoint=null;
    geometries = [];
    if(gpsMarker){map.removeLayer(gpsMarker);gpsMarker=null;}
    if(accuracyCircle){map.removeLayer(accuracyCircle);accuracyCircle=null;}
    clearAllLabels();infoPrecision.innerText='ðŸ“¡ PrecisiÃ³n: -- m';localStorage.removeItem("bps_sesion");
    if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;document.getElementById('btn-gps').innerHTML='<i class="fa-solid fa-location-dot"></i>&nbsp;Activar GPS';}
    showStatus('ðŸ§¹ Todo eliminado','#d9534f');
  };

  </script>
</body>
</html>
